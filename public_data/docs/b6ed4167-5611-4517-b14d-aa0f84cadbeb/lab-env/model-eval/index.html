<!DOCTYPE html>

<html data-bs-theme="light" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="../../img/favicon.ico" rel="shortcut icon"/>
<title>Model Evaluation Pipeline - PrompGuard Technical Spec</title>
<link href="../../css/bootstrap.min.css" rel="stylesheet"/>
<link href="../../css/fontawesome.min.css" rel="stylesheet"/>
<link href="../../css/brands.min.css" rel="stylesheet"/>
<link href="../../css/solid.min.css" rel="stylesheet"/>
<link href="../../css/v4-font-face.min.css" rel="stylesheet"/>
<link href="../../css/base.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" id="hljs-light" rel="stylesheet"/>
<link disabled="" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" id="hljs-dark" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
<script>hljs.highlightAll();</script>
</head>
<body>
<div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
<div class="container">
<a class="navbar-brand" href="../..">PrompGuard Technical Spec</a>
<!-- Expander button -->
<button aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-bs-target="#navbar-collapse" data-bs-toggle="collapse" type="button">
<span class="navbar-toggler-icon"></span>
</button>
<!-- Expanded navigation -->
<div class="navbar-collapse collapse" id="navbar-collapse">
<!-- Main navigation -->
<ul class="nav navbar-nav">
<li class="nav-item">
<a class="nav-link" href="../..">Home</a>
</li>
<li class="nav-item dropdown">
<a aria-current="page" aria-expanded="false" class="nav-link dropdown-toggle active" data-bs-toggle="dropdown" href="#" role="button">Lab Environment</a>
<ul class="dropdown-menu">
<li>
<a class="dropdown-item" href="../intro/">Introduction</a>
</li>
<li>
<a class="dropdown-item" href="../hlds/">High Level Design</a>
</li>
<li>
<a class="dropdown-item" href="../txn-risk-score/">Transaction Risk Score</a>
</li>
<li>
<a class="dropdown-item" href="../data-prep/">Data Preparation</a>
</li>
<li>
<a aria-current="page" class="dropdown-item active" href="./">Model Evaluation Pipeline</a>
</li>
<li>
<a class="dropdown-item" href="../model-train/">Model Training Pipeline</a>
</li>
<li>
<a class="dropdown-item" href="../version-ctrl/">Fraud Engine Version Control</a>
</li>
<li class="dropdown-submenu">
<a class="dropdown-item" href="#">Common Components</a>
<ul class="dropdown-menu">
<li>
<a class="dropdown-item" href="../common-components/redis/">Redis</a>
</li>
<li>
<a class="dropdown-item" href="../common-components/kafka/">Kafka</a>
</li>
<li>
<a class="dropdown-item" href="../common-components/seaweed/">SeaweedFS</a>
</li>
<li>
<a class="dropdown-item" href="../common-components/postgres/">Postgres</a>
</li>
<li>
<a class="dropdown-item" href="../common-components/airflow/">Apache Airflow</a>
</li>
</ul>
</li>
</ul>
</li>
<li class="nav-item">
<a class="nav-link" href="../../prod-env/">Prod Environment</a>
</li>
<li class="nav-item">
<a class="nav-link" href="../../api-std/">API Standard</a>
</li>
</ul>
<ul class="nav navbar-nav ms-md-auto">
<li class="nav-item">
<a class="nav-link" data-bs-target="#mkdocs_search_modal" data-bs-toggle="modal" href="#">
<i class="fa fa-search"></i> Search
                            </a>
</li>
<li class="nav-item">
<a class="nav-link" href="../data-prep/" rel="prev">
<i class="fa fa-arrow-left"></i> Previous
                                </a>
</li>
<li class="nav-item">
<a class="nav-link" href="../model-train/" rel="next">
                                    Next <i class="fa fa-arrow-right"></i>
</a>
</li>
<li class="nav-item dropdown">
<button aria-expanded="false" aria-label="Toggle theme" class="nav-link dropdown-toggle" data-bs-display="static" data-bs-toggle="dropdown" id="theme-menu">
<i class="fa-solid fa-circle-half-stroke fa-fw"></i>
<span class="d-lg-none ms-2">Toggle theme</span>
</button>
<ul class="dropdown-menu dropdown-menu-end">
<li>
<button aria-pressed="true" class="dropdown-item d-flex align-items-center" data-bs-theme-value="light">
<i class="fa-solid fa-sun fa-fw"></i>
<span class="ms-2">Light</span>
<i class="fa-solid fa-check ms-auto"></i>
</button>
</li>
<li>
<button aria-pressed="false" class="dropdown-item d-flex align-items-center" data-bs-theme-value="dark">
<i class="fa-solid fa-moon fa-fw"></i>
<span class="ms-2">Dark</span>
<i class="fa-solid fa-check ms-auto d-none"></i>
</button>
</li>
<li>
<button aria-pressed="false" class="dropdown-item d-flex align-items-center" data-bs-theme-value="auto">
<i class="fa-solid fa-circle-half-stroke fa-fw"></i>
<span class="ms-2">Auto</span>
<i class="fa-solid fa-check ms-auto d-none"></i>
</button>
</li>
</ul>
</li>
</ul>
</div>
</div>
</div>
<script src="../../js/darkmode.js"></script>
<div class="container">
<div class="row">
<div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
<div class="navbar-header">
<button class="navbar-toggler collapsed" data-bs-target="#toc-collapse" data-bs-toggle="collapse" title="Table of Contents" type="button">
<span class="fa fa-angle-down"></span>
</button>
</div>
<div class="navbar-collapse collapse card bg-body-tertiary" id="toc-collapse">
<ul class="nav flex-column">
<li class="nav-item" data-bs-level="1"><a class="nav-link" href="#model-evaluation-pipeline">Model Evaluation Pipeline</a>
<ul class="nav flex-column">
<li class="nav-item" data-bs-level="2"><a class="nav-link" href="#conceptual-flow">Conceptual flow</a>
<ul class="nav flex-column">
</ul>
</li>
<li class="nav-item" data-bs-level="2"><a class="nav-link" href="#flows">Flows</a>
<ul class="nav flex-column">
</ul>
</li>
<li class="nav-item" data-bs-level="2"><a class="nav-link" href="#apache-airflow-pipelines">Apache Airflow pipelines</a>
<ul class="nav flex-column">
</ul>
</li>
<li class="nav-item" data-bs-level="2"><a class="nav-link" href="#data-prep-workers">Data Prep workers</a>
<ul class="nav flex-column">
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div></div>
<div class="col-md-9" role="main">
<h1 id="model-evaluation-pipeline">Model Evaluation Pipeline</h1>
<p>PromptGuard is designed to self maintaining in term of model performance.
It will periodically evaluate and update prediction models.</p>
<p><img alt="Model Evaluation Pipeline Component Diagram" src="images/eval-c3.png" title="Model Evaluation Pipeline Component Diagram"/></p>
<p>We can evaluate both model performance and how much users follow our score suggestion (trust the score).
To evaluate how user trust our scores, we can use high risk score PromptPay proxy lookup vs credit transfer transaction. If they believe the score, there will be less credit transfer transaction than the lookup.</p>
<p>But later on in this doc, we will focus on how to evaluate the model performance.</p>
<h2 id="conceptual-flow">Conceptual flow</h2>
<p>Below is a conceptual flow of the model evaluation pipeline and performance maintainance.</p>
<div class="mermaid">flowchart TD
    T_auto([Schedule Trigger]) --&gt; SD[Check PP data statistical diff]
    T_manual([Manual Trigger]) --&gt; SD
    T_auto --&gt; find_new[Regulary train new challenger models]
    find_new --&gt; chal_model[new model w current features]
    SD --&gt; cond_sd_diff{diif &gt; threshold α}
    cond_sd_diff -- No --&gt; ending([End])
    cond_sd_diff -- Yes --&gt; noti@{ shape: display, label: "Notify to admin"}

    T_auto([Schedule Trigger]) --&gt; model_eval[Test model performance]
    T_manual([Manual Trigger]) --&gt; model_eval
    model_eval --&gt; cond_model_diff{performance &lt; threshold β}
    cond_model_diff -- No --&gt; ending
    cond_model_diff -- Yes --&gt; noti

    noti -- Admin take action --&gt; cond_new_feature{Use current or new features?}

    cond_new_feature -- New --&gt; train_new[Train new feature model offline]
    cond_new_feature -- Current --&gt; chal_model
    chal_model --&gt;replace[Replace old model]
    train_new --&gt; new_pipe[Deploy new data pipeline]
    new_pipe --&gt; replace

    replace --&gt; keep_model[Keep top models for N months]
    keep_model --&gt; ending

</div>
<p><strong>Design principles:</strong><br/>
- For the current features used, the model will be shadowing regulary trained. To make sure, we always have a better model standing by.
- The model retention period or number can be configurable, to make sure, we can recover from a previous model version, if needed.
- All change decisions are made by human.</p>
<p><strong>Note that:</strong> Any feature change will impact both model and feature preparation.</p>
<h2 id="flows">Flows</h2>
<p>Here we show the sequential diagrams of the evaluation pipeline:</p>
<div class="mermaid">sequenceDiagram
    participant EV as Evaluation Pipeline
    participant TRN as Training Pipeline
    participant TXN as PP TXN
    participant MDL as Model Repo
    participant PDR as Predicted Result
    participant CFR as Answer from CFR
    participant FT as Feature Store
    participant DB as Eval DB

    TRN-&gt;&gt;TRN: regulary train new challenger models
    TRN-&gt;&gt;MDL: save challenger models &lt;br&gt; and their corresponse data set to repo

    note over EV,MDL: check statistical diff

    EV-&gt;&gt;TXN: get PP model trained data &lt;br&gt; and up-to-date data
    activate EV
    activate TXN
    TXN--&gt;&gt;EV: PP transaction data
    deactivate TXN
    EV-&gt;&gt;EV: check statistical diff
    EV-&gt;&gt;DB: save statistical diff

    alt diff &gt; threshold
        EV-&gt;&gt;EV: notify to admin &lt;br&gt; (to maintain model performance and features)
        EV-&gt;&gt;EV: check model performance drop (below section)
        deactivate EV
    end

    note over EV,CFR: check model performance drop

    EV-&gt;&gt;PDR: get historical predicted result of the current model
    activate EV
    activate PDR
    PDR--&gt;&gt;EV: predicted result
    deactivate PDR
    EV-&gt;&gt;CFR: get actual answer from CFR
    activate CFR
    CFR--&gt;&gt;EV: actual answer
    deactivate CFR
    EV-&gt;&gt;EV: check model performance drop
    EV-&gt;&gt;DB: save model performance

    alt drop &gt; threshold
        EV-&gt;&gt;MDL: get best challenger model
        activate MDL
        MDL--&gt;&gt;EV: challenger model
        deactivate MDL
        EV-&gt;&gt;FT: get feature snapshot of the current model predicted
        activate FT
        FT--&gt;&gt;EV: feature snapshot
        deactivate FT
        EV-&gt;&gt;EV: try these features with the challenger model, &lt;br&gt; then compare performance with the current model
        EV-&gt;&gt;EV: notify admin &lt;br&gt; (to know the drop &lt;br&gt; or deploy new model)
        deactivate EV
    end
</div>
<blockquote>
<p>⚠️ As of 2025, actual answer from CFR is delay around 21 days to complete for the <em>invesment fraud</em> cases, and 3 days for others.</p>
</blockquote>
<h2 id="apache-airflow-pipelines">Apache Airflow pipelines</h2>
<p>TODO detail of the Airflow</p>
<h2 id="data-prep-workers">Data Prep workers</h2>
<p>These are data preparation workers saving data to SeaweedFS for evaluation pipeline.</p>
<ul>
<li>PromptPay Transaction Recorder. <a href="../data-prep/#promptpay-transaction-recorder">Detail</a></li>
<li>Predicted Score Capture. <a href="../data-prep/#predicted-score-capture">Detail</a></li>
<li>CFR Data Capture. <a href="../data-prep/#cfr-data-capture">Detail</a></li>
</ul></div>
</div>
</div>
<footer class="col-md-12">
<hr/>
<p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
</footer>
<script src="../../js/bootstrap.bundle.min.js"></script>
<script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
<script src="../../js/base.js"></script>
<script src="../../search/main.js"></script>
<div aria-hidden="true" aria-labelledby="searchModalLabel" class="modal" id="mkdocs_search_modal" role="dialog" tabindex="-1">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<div class="modal-header">
<h4 class="modal-title" id="searchModalLabel">Search</h4>
<button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body">
<p>From here you can search these documents. Enter your search terms below.</p>
<form>
<div class="form-group">
<input class="form-control" id="mkdocs-search-query" placeholder="Search..." title="Type search term here" type="search"/>
</div>
</form>
<div data-no-results-text="No results found" id="mkdocs-search-results"></div>
</div>
<div class="modal-footer">
</div>
</div>
</div>
</div><div aria-hidden="true" aria-labelledby="keyboardModalLabel" class="modal" id="mkdocs_keyboard_modal" role="dialog" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
<button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body">
<table class="table">
<thead>
<tr>
<th style="width: 20%;">Keys</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr>
<td class="help shortcut"><kbd>?</kbd></td>
<td>Open this help</td>
</tr>
<tr>
<td class="next shortcut"><kbd>n</kbd></td>
<td>Next page</td>
</tr>
<tr>
<td class="prev shortcut"><kbd>p</kbd></td>
<td>Previous page</td>
</tr>
<tr>
<td class="search shortcut"><kbd>s</kbd></td>
<td>Search</td>
</tr>
</tbody>
</table>
</div>
<div class="modal-footer">
</div>
</div>
</div>
</div>
<script type="module">import mermaid from "https://unpkg.com/mermaid@11.12.2/dist/mermaid.esm.min.mjs";
mermaid.initialize({});</script></body>
</html>
